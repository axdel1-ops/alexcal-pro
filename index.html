<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
    <meta name="theme-color" content="#0f1720">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" href="icon.png" type="image/png">
    <link rel="manifest" href="manifest.json">
    <title>ALEXCAL Pro v3</title>

    <style>
        :root{
            --bg:#0f1720; --card:#0b1220; --text:#e6eef8; --muted:#9aa7bf;
            --titleBg:#ffffff; --titleText:#000; --inputBg:#fbc02d;
            --systemBg:#bbdefb; --resultBg:#bbdefb; --okBg:#c8e6c9; --alertBg:#ffcdd2;
            --blue:#1976d2;
        }
        body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui, Arial; font-size: 14px;}
        .app{max-width:950px;margin:16px auto;padding:16px;}
        h1{text-align:center;font-size:22px;margin-bottom:14px; color: var(--inputBg);}
        .layout{display:flex;flex-wrap:wrap;gap:16px;}
        .table{background:var(--card);padding:12px;border-radius:8px;width:100%; box-sizing: border-box;}
        @media(min-width:900px){.half{width:48.9%;}}
        .row{display:flex;align-items:center;gap:10px;margin-top:8px;}
        .label{width:44%;color:var(--muted);font-weight:600;}
        .title{background:var(--titleBg);color:var(--titleText);width:100%;padding:8px;border-radius:6px;text-align:center;font-weight:700;text-transform: uppercase;}
        select,input{width:56%;padding:8px;border-radius:6px;border:none;background:var(--inputBg);color:#000;font-weight: 600;}
        select.system{background:var(--systemBg);}
        .result{width:56%;padding:8px;border-radius:6px;background:var(--resultBg);color:#000;font-weight:700; min-height: 20px;}
        .result.ok{background:var(--okBg);}
        .result.alert{background:var(--alertBg);}
        button{padding:10px 20px;border:none;border-radius:6px;background:var(--blue);color:#fff;font-weight:700;cursor:pointer; flex: 1;}
        .btn-group{display:flex; gap:10px; width:100%; margin-top:10px;}
        .footer{text-align:center;margin-top:32px;padding-top:20px;border-top:1px solid rgba(230,238,248,0.1); opacity: 0.7;}
        .footer-credit{color:var(--muted);font-size:16px;font-weight:700; line-height: 1.6;}

        #modalTabla {
            display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
            background:rgba(0,0,0,0.95); z-index:1000; overflow-y:auto; padding:20px; box-sizing:border-box;
        }
        .modal-content { max-width:900px; margin:0 auto; background:#fff; color:#000; border-radius:8px; padding:15px; }
        table { width:100%; border-collapse:collapse; font-size:11px; text-align:center; }
        th { background:#333; color:#fff; padding:8px; }
        td { border:1px solid #ccc; padding:6px; }
        .sticky-btn { position: sticky; top: 0; background: #d32f2f; color: white; border: none; padding: 10px; width: 100%; font-weight: bold; cursor: pointer; border-radius: 4px; margin-bottom: 10px; }
    </style>
</head>
<body>

<div id="modalTabla" onclick="cerrarTabla()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <button class="sticky-btn" onclick="cerrarTabla()">CERRAR TABLA (X)</button>
        <h3>Tabla 310.15(b)(16) Ampacidad de Conductores</h3>
        <table id="tablaVisual">
            <thead>
                <tr>
                    <th rowspan="2">Calibre (AWG/kcmil)</th>
                    <th rowspan="2">mm²</th>
                    <th colspan="3">Cobre (Cu)</th>
                    <th colspan="3">Aluminio (Al)</th>
                </tr>
                <tr>
                    <th>60°C</th><th>75°C</th><th>90°C</th>
                    <th>60°C</th><th>75°C</th><th>90°C</th>
                </tr>
            </thead>
            <tbody id="cuerpoTabla"></tbody>
        </table>
    </div>
</div>

<div class="app">
    <h1>ALEXCAL v3 - Profesional</h1>
    <div class="layout">
        <div class="table full">
            <div class="row"><div class="title">CALCULADORA DE POTENCIA</div></div>
            <div class="row">
                <div class="label">Sistema</div>
                <select id="sistema" class="system" onchange="clearPower()">
                    <option value="mono">Monofásico</option>
                    <option value="bi">Bifásico</option>
                    <option value="tri">Trifásico</option>
                </select>
            </div>
            <div class="row">
                <div class="label">Material</div>
                <select id="matCalc" onchange="clearPower()">
                    <option value="cu">Cobre (Cu)</option>
                    <option value="al">Aluminio (Al)</option>
                </select>
            </div>
            <div class="row"><div class="label">Voltaje (V)</div><input id="volt" type="number" value="127"></div>
            <div class="row"><div class="label">Factor de potencia</div><input id="fp" type="number" value="0.9"></div>
            <div class="row"><div class="label">Potencia (kVA)</div><input id="kva" type="number" step="0.01"></div>
            <div class="row"><div class="label">Corriente (A)</div><input id="i" type="number" step="0.01"></div>
            <div class="row"><div class="label">Calibre sugerido</div><div id="cal_rec" class="result">-</div></div>
            <div class="row"><div class="label">Distancia (m) - Opcional</div><input id="dist" type="number" placeholder="0"></div>
            <div class="row"><div class="label">% Caída Máx admisible</div><input id="vdrop" type="number" value="3"></div>
            
            <div class="btn-group">
                <button onclick="calcPower()">Calcular</button>
                <button onclick="abrirTabla()" style="background:#455a64;">Consultar Tabla</button>
                <button onclick="clearPower()" style="background:#d32f2f;">Borrar</button>
            </div>
        </div>

        <div class="table half">
            <div class="row"><div class="title">INSTALACIÓN ORIGINAL</div></div>
            <div class="row"><div class="label">Uso</div><select id="uso" onchange="runComp()"><option value="res">Residencial</option><option value="com">Comercial</option><option value="ind">Industrial</option></select></div>
            <div class="row"><div class="label">Sistema</div><select id="tipo1" onchange="runComp()"><option value="mono">Monofásica (120V)</option><option value="trifilar">Trifilar (240V)</option><option value="tri">Trifásica (208V)</option></select></div>
            <div class="row"><div class="label">Temp</div><select id="temp" onchange="runComp()"><option value="60">60 °C</option><option value="75" selected>75 °C</option><option value="90">90 °C</option></select></div>
            <div class="row"><div class="label">Calibre</div><select id="cal1" onchange="runComp()"></select></div>
            <div class="row"><div class="label">Capacidad (kVA)</div><div id="kva1" class="result">-</div></div>
        </div>

        <div class="table half">
            <div class="row"><div class="title">INSTALACIÓN MODIFICADA</div></div>
            <div class="row"><div class="label">Sistema</div><select id="tipo2" onchange="runComp()"><option value="mono">Monofásica (120V)</option><option value="trifilar">Trifilar (240V)</option><option value="tri">Trifásica (208V)</option></select></div>
            <div class="row"><div class="label">Calibre</div><select id="cal2" onchange="runComp()"></select></div>
            <div class="row"><div class="label">Capacidad (kVA)</div><div id="kva2" class="result">-</div></div>
        </div>

        <div class="table full">
            <div class="row"><div class="label">Cambio de Carga</div><div id="delta" class="result">-</div></div>
            <div class="row"><div class="label">Estado / Dictamen</div><div id="dictamen" class="result">-</div></div>
        </div>
    </div>

    <div class="footer">
        <div class="footer-credit">
            Creado por: AlexDel<br>
            úselo bajo su responsabilidad.
        </div>
    </div>
</div>

<script>
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js').then(reg => console.log('SW activo')).catch(err => console.log('SW error', err));
    });
}

const conductores = [
    {id:"14", mm:2.08, cu:[15,20,25], al:[0,0,0]},
    {id:"12", mm:3.31, cu:[20,25,30], al:[15,20,25]},
    {id:"10", mm:5.26, cu:[30,35,40], al:[25,30,35]},
    {id:"8",  mm:8.37, cu:[40,50,55], al:[30,40,45]},
    {id:"6",  mm:13.3, cu:[55,65,75], al:[40,50,55]},
    {id:"4",  mm:21.2, cu:[70,85,95], al:[55,65,75]},
    {id:"2",  mm:33.6, cu:[95,115,130], al:[75,90,100]},
    {id:"1/0", mm:53.5, cu:[125,150,170], al:[100,120,135]},
    {id:"2/0", mm:67.4, cu:[145,175,195], al:[115,135,150]},
    {id:"3/0", mm:85.0, cu:[165,200,225], al:[130,155,175]},
    {id:"4/0", mm:107,  cu:[195,230,260], al:[150,180,205]},
    {id:"250", mm:127,  cu:[215,255,290], al:[170,205,230]},
    {id:"350", mm:177,  cu:[260,310,350], al:[210,250,280]},
    {id:"500", mm:253,  cu:[320,380,430], al:[260,310,350]}
];

const FACTOR={mono:1, bi:2, tri:Math.sqrt(3), trifilar:2};

window.onload = () => {
    const s1 = document.getElementById('cal1');
    const s2 = document.getElementById('cal2');
    const cuerpo = document.getElementById('cuerpoTabla');
    conductores.forEach(c => {
        const text = c.id + (parseInt(c.id)>10 || c.id.includes('/')?" kcmil":" AWG");
        s1.options.add(new Option(text, c.id));
        s2.options.add(new Option(text, c.id));
        let fila = `<tr><td>${c.id}</td><td>${c.mm}</td><td>${c.cu[0]}</td><td>${c.cu[1]}</td><td>${c.cu[2]}</td><td>${c.al[0]||'-'}</td><td>${c.al[1]||'-'}</td><td>${c.al[2]||'-'}</td></tr>`;
        cuerpo.innerHTML += fila;
    });
    s1.value = "8"; s2.value = "6";
    runComp();
};

function abrirTabla(){ document.getElementById('modalTabla').style.display='block'; }
function cerrarTabla(){ document.getElementById('modalTabla').style.display='none'; }

function runComp() {
    const uso = document.getElementById('uso').value;
    const tIdx = {"60":0, "75":1, "90":2}[document.getElementById('temp').value];
    const getV = (tipo) => (tipo === "tri") ? 208 : (tipo === "trifilar" ? 240 : 120);
    const c1Data = conductores.find(c => c.id === document.getElementById('cal1').value);
    const amp1 = c1Data.cu[tIdx];
    const sys1 = document.getElementById('tipo1').value;
    const kva1 = (getV(sys1) * amp1 * FACTOR[sys1]) / 1000;
    const c2Data = conductores.find(c => c.id === document.getElementById('cal2').value);
    const amp2 = c2Data.cu[tIdx];
    const sys2 = document.getElementById('tipo2').value;
    const kva2 = (getV(sys2) * amp2 * FACTOR[sys2]) / 1000;
    document.getElementById('kva1').textContent = kva1.toFixed(2);
    document.getElementById('kva2').textContent = kva2.toFixed(2);
    const diff = kva2 - kva1;
    const porc = kva1 > 0 ? (diff / kva1) * 100 : 0;
    document.getElementById('delta').textContent = `${diff > 0 ? '+':''}${diff.toFixed(2)} kVA (${porc > 0 ? '+':''}${porc.toFixed(1)}%)`;
    let req = false;
    if(uso==="res"){ if(kva2 > 10 || porc > 50) req = true; }
    else if(uso==="com"){ if(kva2 > 10) req = true; }
    else if(uso==="ind"){ if(kva2 > 20) req = true; }
    if(sys1 !== sys2) req = true;
    const d = document.getElementById('dictamen');
    d.textContent = req ? "REQUIERE DICTAMEN RETIE" : "NO REQUIERE DICTAMEN";
    d.className = "result " + (req ? "alert" : "ok");
}

function calcPower(){
    const V = parseFloat(document.getElementById('volt').value);
    const sistema = document.getElementById('sistema').value;
    const mat = document.getElementById('matCalc').value;
    const k = FACTOR[sistema];
    const L = parseFloat(document.getElementById('dist').value) || 0;
    const dMax = parseFloat(document.getElementById('vdrop').value) || 3;
    let S = parseFloat(document.getElementById('kva').value);
    let I = parseFloat(document.getElementById('i').value);
    if(S > 0) { I = (S * 1000) / (V * k); document.getElementById('i').value = I.toFixed(2); } 
    else if(I > 0) { S = (V * I * k) / 1000; document.getElementById('kva').value = S.toFixed(2); }
    if (!I) return;
    let bestCond = null;
    const maxCond = conductores[conductores.length - 1];
    const maxAmp = (mat === "cu") ? maxCond.cu[1] : maxCond.al[1];
    if (I <= maxAmp) { bestCond = conductores.find(c => ((mat === "cu") ? c.cu[1] : c.al[1]) >= I); } 
    else { bestCond = maxCond; }
    if (L > 0) {
        const rho = (mat === "cu") ? 0.0172 : 0.0282;
        const kDist = (sistema === "tri") ? Math.sqrt(3) : 2;
        let index = conductores.indexOf(bestCond);
        while (index < conductores.length) {
            let current = conductores[index];
            let numP = (I > maxAmp) ? Math.ceil(I / maxAmp) : 1;
            let section = current.mm * numP;
            let drop = (kDist * L * I * rho) / (section * V) * 100;
            if (drop <= dMax) { bestCond = current; break; } else { index++; }
        }
    }
    let rec = (I > maxAmp) ? (Math.ceil(I / maxAmp) + " x " + bestCond.id + " kcmil") : (bestCond.id + (parseInt(bestCond.id) > 10 || bestCond.id.includes('/') ? " kcmil" : " AWG"));
    document.getElementById('cal_rec').textContent = rec;
}

function clearPower(){
    document.getElementById('kva').value=""; document.getElementById('i').value="";
    document.getElementById('dist').value=""; document.getElementById('cal_rec').textContent="-";
}
</script>
</body>
</html>